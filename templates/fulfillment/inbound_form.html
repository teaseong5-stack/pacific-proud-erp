{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-4" style="max-width: 1000px;">
    
    <div class="d-flex align-items-center mb-4">
        <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3 shadow" style="width: 50px; height: 50px;">
            <i class="bi bi-box-seam fs-4"></i>
        </div>
        <div>
            <h3 class="fw-bold mb-0">ì‹ ê·œ ìì¬ ì…ê³ </h3>
            <p class="text-muted mb-0 small">ë¬¼ë¥˜ì„¼í„° ì…ê³  ì²˜ë¦¬ ë° ë°”ì½”ë“œ ë¼ë²¨ ë°œí–‰</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4">
                    <form method="post" id="inboundForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold text-primary">ğŸ“¦ ì…ê³  ìƒí’ˆ ì„ íƒ</label>
                            {{ form.product }}
                            <div class="form-text">ìƒí’ˆëª…, SKU, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-primary">ğŸ“ ì ì¹˜ ìœ„ì¹˜ (Location)</label>
                            {{ form.location }}
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-primary">ğŸ”¢ ì…ê³  ìˆ˜ëŸ‰</label>
                            <div class="input-group input-group-lg">
                                {{ form.quantity }}
                                <span class="input-group-text bg-light fw-bold" id="unitDisplay" style="min-width: 80px;">Unit</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-primary">ğŸ“… ìœ í†µê¸°í•œ (Expiry Date)</label>
                            {{ form.expiry_date }}
                            
                            <div class="d-flex gap-2 mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDate(7)">+1ì£¼</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDate(30)">+1ê°œì›”</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDate(180)">+6ê°œì›”</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDate(365)">+1ë…„</button>
                            </div>
                        </div>

                        <hr class="my-4">

                        <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm py-3">
                            <i class="bi bi-qr-code me-2"></i> ì…ê³  í™•ì • ë° ë¼ë²¨ ì¶œë ¥
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 bg-light h-100">
                <div class="card-body p-4 text-center d-flex flex-column justify-content-center" id="emptyState">
                    <i class="bi bi-basket3 display-1 text-muted opacity-25 mb-3"></i>
                    <h5 class="text-muted">ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”</h5>
                    <p class="text-muted small">ì„ íƒí•œ ìƒí’ˆì˜ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <div class="card-body p-4 d-none" id="productInfoCard">
                    <div class="text-center mb-4">
                        <div class="badge bg-warning text-dark mb-2 fs-6 shadow-sm" id="infoCategory">ì¹´í…Œê³ ë¦¬</div>
                        <h4 class="fw-bold mb-1" id="infoName">ìƒí’ˆëª…</h4>
                        <p class="text-muted font-monospace" id="infoSku">SKU-CODE</p>
                    </div>

                    <ul class="list-group shadow-sm rounded-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <span>ğŸ“ ê¸°ì¤€ ê·œê²©(ë‹¨ìœ„)</span>
                            <span class="fw-bold fs-5 text-primary" id="infoUnit">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <span>â„ï¸ ë³´ê´€ ë°©ë²•</span>
                            <span class="fw-bold" id="infoStorage">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <span>â³ ê¶Œì¥ ìœ í†µê¸°í•œ</span>
                            <span class="fw-bold" id="infoShelfLife">-</span>
                        </li>
                    </ul>
                    
                    <div class="alert alert-info mt-4 d-flex align-items-center shadow-sm">
                        <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                        <div>
                            ì…ê³  ì‹œ <strong>ë°°ì¹˜ ë²ˆí˜¸</strong>ê°€<br>ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="productData" style="display:none;">
    {% for p in products %}
    <div data-id="{{ p.id }}" 
         data-name="{{ p.name }}" 
         data-sku="{{ p.sku }}" 
         data-unit="{{ p.unit }}" 
         data-category="{{ p.get_category_display }}"
         data-storage="{{ p.get_storage_type_display }}"
         data-shelflife="{{ p.shelf_life_days }}"></div>
    {% endfor %}
</div>

<script>
    // 1. ìƒí’ˆ ì„ íƒ ì‹œ ìš°ì¸¡ ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
    $(document).ready(function() {
        // Select2 ì ìš© (ê²€ìƒ‰ ê¸°ëŠ¥)
        $('.search-select').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'ê²€ìƒ‰ ë˜ëŠ” ì„ íƒ'
        });

        // ë³€ê²½ ì´ë²¤íŠ¸ ê°ì§€
        $('#id_product').on('change', function() {
            const selectedId = $(this).val();
            
            if (selectedId) {
                // ë°ì´í„° ì°¾ê¸°
                const dataDiv = $(`#productData div[data-id="${selectedId}"]`);
                const name = dataDiv.data('name');
                const sku = dataDiv.data('sku');
                const unit = dataDiv.data('unit');
                const category = dataDiv.data('category');
                const storage = dataDiv.data('storage');
                const shelfLife = dataDiv.data('shelflife');

                // í™”ë©´ ê°±ì‹ 
                $('#infoName').text(name);
                $('#infoSku').text(sku);
                $('#infoUnit').text(unit);
                $('#unitDisplay').text(unit); // ì…ë ¥ì°½ ì˜† ë‹¨ìœ„ ë³€ê²½
                $('#infoCategory').text(category);
                $('#infoStorage').text(storage);
                $('#infoShelfLife').text(shelfLife + "ì¼");

                // UI ì „í™˜
                $('#emptyState').addClass('d-none');
                $('#productInfoCard').removeClass('d-none').hide().fadeIn(300);
            } else {
                // ì´ˆê¸°í™”
                $('#emptyState').removeClass('d-none');
                $('#productInfoCard').addClass('d-none');
                $('#unitDisplay').text("Unit");
            }
        });
    });

    // 2. ë‚ ì§œ í€µ ë²„íŠ¼ ê¸°ëŠ¥
    function setDate(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        
        // Django í¼ IDëŠ” id_í•„ë“œëª… í˜•ì‹
        document.getElementById('id_expiry_date').value = `${yyyy}-${mm}-${dd}`;
    }
</script>
{% endblock %}