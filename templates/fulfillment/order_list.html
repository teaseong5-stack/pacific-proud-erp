{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸšš ì£¼ë¬¸ ë° ì¶œê³  ê´€ë¦¬</h2>
    
    <div>
        <a href="{% url 'fulfillment:export_order' %}?{{ request.GET.urlencode }}" class="btn btn-success me-2">
            <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
            <i class="bi bi-plus-lg"></i> ì‹ ê·œ ì£¼ë¬¸ ì ‘ìˆ˜
        </button>
    </div>
</div>

<div class="card shadow-sm mb-4 bg-light">
    <div class="card-body py-3">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold small">ì£¼ë¬¸ ê¸°ê°„</label>
                <div class="input-group">
                    <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
                    <span class="input-group-text">~</span>
                    <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold small">ë‚©í’ˆì²˜ (ê³ ê°)</label>
                <select name="client" class="form-select search-select">
                    <option value="">ì „ì²´ ê³ ê°</option>
                    {% for cli in clients %}
                        <option value="{{ cli.id }}" {% if request.GET.client == cli.id|stringformat:"s" %}selected{% endif %}>
                            {{ cli.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold small">ì§„í–‰ ìƒíƒœ</label>
                <select name="status" class="form-select">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="PENDING" {% if request.GET.status == 'PENDING' %}selected{% endif %}>ì ‘ìˆ˜ëŒ€ê¸°</option>
                    <option value="ALLOCATED" {% if request.GET.status == 'ALLOCATED' %}selected{% endif %}>í”¼í‚¹ì¤‘</option>
                    <option value="SHIPPED" {% if request.GET.status == 'SHIPPED' %}selected{% endif %}>ì¶œê³ ì™„ë£Œ</option>
                </select>
            </div>

            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-secondary flex-fill">
                    <i class="bi bi-search"></i> ì¡°íšŒ
                </button>
                <a href="{% url 'fulfillment:order_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> ì´ˆê¸°í™”
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ë‚©í’ˆì²˜ (ê³ ê°)</th>
                    <th>ì£¼ë¬¸ì¼ì</th>
                    <th>ì´ ë§¤ì¶œì•¡</th>
                    <th>ìƒíƒœ</th>
                    <th class="text-center">ê´€ë¦¬ (í”„ë¡œì„¸ìŠ¤)</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td class="fw-bold">{{ order.client.name }}</td>
                    <td>{{ order.order_date|date:"Y-m-d" }}</td>
                    <td class="fw-bold">{{ order.total_revenue|intcomma }} Ä‘</td>
                    <td>
                        {% if order.status == 'SHIPPED' %} <span class="badge bg-success">ì¶œê³ ì™„ë£Œ</span>
                        {% elif order.status == 'ALLOCATED' %} <span class="badge bg-info text-dark">í”¼í‚¹ì¤‘</span>
                        {% else %} <span class="badge bg-warning text-dark">ì ‘ìˆ˜ëŒ€ê¸°</span> {% endif %}
                    </td>
                    <td class="text-center" style="white-space: nowrap;">
                        <a href="{% url 'fulfillment:process_weight' order.id %}" class="btn btn-sm btn-outline-success me-1" title="ì¤‘ëŸ‰/ê²€ìˆ˜">
                            <i class="bi bi-ui-checks"></i>
                        </a>
                        <a href="{% url 'fulfillment:generate_invoice' order.id %}" class="btn btn-sm btn-outline-secondary me-1" target="_blank" title="ëª…ì„¸ì„œ">
                            <i class="bi bi-receipt"></i>
                        </a>
                        <a href="{% url 'fulfillment:order_update' order.id %}" class="btn btn-sm btn-outline-primary me-1" title="ìˆ˜ì •">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="{% url 'fulfillment:order_delete' order.id %}" class="btn btn-sm btn-outline-danger" title="ì‚­ì œ">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center p-4">ê²€ìƒ‰ëœ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ğŸšš ì‹ ê·œ ì£¼ë¬¸ ë“±ë¡ (í†µí•©)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" action="{% url 'fulfillment:order_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3 mb-4 bg-light p-3 rounded border">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ë‚©í’ˆì²˜ (ê³ ê°)</label>
                            {{ form.client }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ìƒíƒœ</label>
                            {{ form.status }}
                        </div>
                    </div>

                    <h6 class="fw-bold mb-2">ğŸ“¦ ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡</h6>
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%;">ìƒí’ˆëª… (ê·œê²©)</th>
                                <th style="width: 20%;">ìˆ˜ëŸ‰</th>
                                <th style="width: 20%;">ì˜ˆìƒ ë‹¨ê°€</th>
                                <th style="width: 20%;">í•©ê³„</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in "12345" %}
                            <tr>
                                <td>
                                    <select name="items-{{ forloop.counter0 }}-product" class="form-select product-select" onchange="updateOrderRow(this)">
                                        <option value="">-- ìƒí’ˆ ì„ íƒ --</option>
                                        {% for prod in products_all %}
                                            <option value="{{ prod.id }}" data-price="{{ prod.price }}" data-unit="{{ prod.unit }}">
                                                {{ prod.name }} ({{ prod.unit }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="items-{{ forloop.counter0 }}-quantity" class="form-control quantity-input" oninput="updateOrderRow(this)">
                                </td>
                                <td>
                                    <input type="text" class="form-control-plaintext text-end price-display" readonly value="0">
                                </td>
                                <td>
                                    <input type="text" class="form-control-plaintext text-end total-display fw-bold" readonly value="0">
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <input type="hidden" name="items-TOTAL_FORMS" value="5">
                            <input type="hidden" name="items-INITIAL_FORMS" value="0">
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end fw-bold">ì´ í•©ê³„ :</td>
                                <td class="text-end fw-bold text-danger fs-5" id="grandTotal">0 Ä‘</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì£¼ë¬¸ ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // 1. ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ Select2 ì´ˆê¸°í™” (ì´ë˜ì•¼ ê²€ìƒ‰ì°½ì´ ì œëŒ€ë¡œ ì‘ë™í•¨)
        $('#addOrderModal').on('shown.bs.modal', function () {
            $('.product-select').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#addOrderModal'), // â˜… í•µì‹¬: íŒì—… ì•ˆì— ê²€ìƒ‰ì°½ ê°€ë‘ê¸°
                placeholder: 'ìƒí’ˆëª… ë˜ëŠ” SKU ê²€ìƒ‰',
                allowClear: true,
                width: '100%'
            });
        });
    });

    // 2. í–‰ë³„ ìë™ ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function updateOrderRow(element) {
        // (ì´ì „ê³¼ ë™ì¼í•œ ê³„ì‚° ë¡œì§)
        // select2ëŠ” change ì´ë²¤íŠ¸ê°€ ì œì´ì¿¼ë¦¬ë¡œ ë°œìƒí•˜ë¯€ë¡œ, onchange="updateOrderRow(this)"ê°€ ì•ˆ ë¨¹í ìˆ˜ ìˆìŒ.
        // ì•„ë˜ì™€ ê°™ì´ ì œì´ì¿¼ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì•ˆì „í•¨.
    }

    // â˜… Select2 ë³€ê²½ ê°ì§€ìš© ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
    $(document).on('select2:select', '.product-select', function(e) {
        // ì„ íƒëœ ìš”ì†Œë¥¼ ì°¾ì•„ì„œ updateOrderRow í˜¸ì¶œê³¼ ê°™ì€ ë¡œì§ ìˆ˜í–‰
        const select = this;
        const row = select.closest('tr');
        const quantityInput = row.querySelector('.quantity-input');
        const priceDisplay = row.querySelector('.price-display');
        const totalDisplay = row.querySelector('.total-display');
        const unitDisplay = row.querySelector('.unit-display'); // ë‹¨ìœ„ í‘œì‹œìš©

        // data ì†ì„±ì€ select2ì—ì„œ ë°”ë¡œ ëª» ê°€ì ¸ì˜¤ë¯€ë¡œ ì›ë³¸ optionì—ì„œ ê°€ì ¸ì˜´
        const selectedOption = select.options[select.selectedIndex];
        const price = selectedOption.dataset.price || 0;
        const unit = selectedOption.dataset.unit || "-";
        
        // í™”ë©´ ê°±ì‹ 
        if(unitDisplay) unitDisplay.value = unit;
        priceDisplay.value = Number(price).toLocaleString() + ' Ä‘';
        
        // ìˆ˜ëŸ‰ì´ ìˆìœ¼ë©´ í•©ê³„ë„ ê³„ì‚°
        const quantity = quantityInput.value || 0;
        totalDisplay.value = Number(price * quantity).toLocaleString() + ' Ä‘';
        totalDisplay.dataset.rawValue = price * quantity;
        
        calculateGrandTotal();
    });

    // ìˆ˜ëŸ‰ ì…ë ¥ ì‹œ ê³„ì‚°
    $(document).on('input', '.quantity-input', function() {
        const row = this.closest('tr');
        const select = row.querySelector('.product-select');
        const totalDisplay = row.querySelector('.total-display');
        
        const selectedOption = select.options[select.selectedIndex];
        const price = selectedOption.dataset.price || 0;
        const quantity = this.value || 0;
        const total = price * quantity;

        totalDisplay.value = Number(total).toLocaleString() + ' Ä‘';
        totalDisplay.dataset.rawValue = total;
        
        calculateGrandTotal();
    });

    function calculateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.total-display').forEach(input => {
            grandTotal += Number(input.dataset.rawValue || 0);
        });
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString() + ' Ä‘';
    }
</script>