{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸ­ ì°½ê³  êµ¬ì—­ ë° ìœ„ì¹˜ ê´€ë¦¬</h2>
    <div>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addZoneModal">
            <i class="bi bi-folder-plus"></i> êµ¬ì—­(Zone) ì¶”ê°€
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLocationModal">
            <i class="bi bi-geo-alt"></i> ì„¸ë¶€ ìœ„ì¹˜ ì¶”ê°€
        </button>
    </div>
</div>

<div class="row g-4">
    {% for zone in zones %}
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="#" class="text-decoration-none fw-bold text-dark fs-5 me-2" 
                       data-bs-toggle="modal" data-bs-target="#zoneInventoryModal{{ zone.id }}"
                       title="í´ë¦­í•˜ì—¬ ì¬ê³  í™•ì¸">
                       {{ zone.name }} <i class="bi bi-search text-primary small" style="font-size: 0.7em;"></i>
                    </a>
                    <span class="badge bg-secondary">{{ zone.get_storage_type_display }}</span>
                </div>
                <a href="{% url 'fulfillment:zone_delete' zone.id %}" class="btn btn-sm text-danger" onclick="return confirm('êµ¬ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•˜ìœ„ ìœ„ì¹˜ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.');">
                    <i class="bi bi-trash"></i>
                </a>
            </div>
            
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for loc in zone.locations.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-box-seam text-muted me-2"></i>
                            {{ loc.code }}
                            {% if loc.inventory_set.exists %}
                                <span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">ì¬ê³ ìˆìŒ</span>
                            {% endif %}
                        </span>
                        <div class="d-flex align-items-center">
                            {% if not loc.is_active %}
                                <span class="badge bg-danger me-2">ì‚¬ìš©ì¤‘ì§€</span>
                            {% endif %}
                            <a href="{% url 'fulfillment:location_delete' loc.id %}" class="btn btn-sm text-muted py-0" onclick="return confirm('ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"><i class="bi bi-x-lg"></i></a>
                        </div>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-4">ë“±ë¡ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer text-muted small">
                ì´ {{ zone.locations.count }}ê°œ ìœ„ì¹˜ / í´ë¦­í•˜ì—¬ ì¬ê³  ì¡°íšŒ
            </div>
        </div>
    </div>

    <div class="modal fade" id="zoneInventoryModal{{ zone.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title fw-bold">ğŸ“¦ [{{ zone.name }}] ì¬ê³  í˜„í™©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0 text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ìœ„ì¹˜ ì½”ë“œ</th>
                                <th>ìƒí’ˆëª…</th>
                                <th>SKU</th>
                                <th>ìœ í†µê¸°í•œ</th>
                                <th class="text-end">ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loc in zone.locations.all %}
                                {% for inv in loc.inventory_set.all %}
                                    {% if inv.quantity > 0 %}
                                    <tr>
                                        <td class="fw-bold text-primary">{{ loc.code }}</td>
                                        <td class="text-start">{{ inv.product.name }}</td>
                                        <td>{{ inv.product.sku }}</td>
                                        <td {% if inv.is_expired %}class="text-danger fw-bold"{% endif %}>
                                            {{ inv.expiry_date|date:"Y-m-d" }}
                                        </td>
                                        <td class="text-end fw-bold">{{ inv.quantity|intcomma }} {{ inv.product.unit }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            
                            {% with has_inventory=False %}
                                {% endwith %}
                        </tbody>
                    </table>
                    
                    <div class="p-3 text-center text-muted small bg-light border-top">
                        * ìˆ˜ëŸ‰ì´ 0ì¸ ì¬ê³ ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center p-5">
        <h4 class="text-muted">ë“±ë¡ëœ ì°½ê³  êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4>
        <p>ìš°ì¸¡ ìƒë‹¨ 'êµ¬ì—­ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="addZoneModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light"><h5 class="modal-title">ğŸ­ ì‹ ê·œ êµ¬ì—­(Zone) ë“±ë¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form method="post" action="{% url 'fulfillment:zone_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label fw-bold">êµ¬ì—­ëª…</label>{{ zone_form.name }}</div>
                    <div class="mb-3"><label class="form-label fw-bold">ë³´ê´€ íƒ€ì…</label>{{ zone_form.storage_type }}</div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ë“±ë¡</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">ğŸ“ ì„¸ë¶€ ìœ„ì¹˜(Location) ë“±ë¡</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form method="post" action="{% url 'fulfillment:location_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label fw-bold">ì†Œì† êµ¬ì—­</label>{{ location_form.zone }}</div>
                    <div class="mb-3"><label class="form-label fw-bold">ìœ„ì¹˜ ì½”ë“œ</label>{{ location_form.code }}<div class="form-text">ì˜ˆ: A-01-01</div></div>
                    <div class="form-check mb-3">{{ location_form.is_active }}<label class="form-check-label">ì‚¬ìš© ê°€ëŠ¥</label></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ë“±ë¡</button></div>
            </form>
        </div>
    </div>
</div>
{% endblock %}