{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
        <div>
            <h2 class="mb-0 fw-bold">ğŸ“Š ì›”ê°„ ì†ìµë³´ê³ ì„œ (I/S)</h2>
            <p class="text-muted mb-0 mt-1">
                ëŒ€ìƒ ê¸°ê°„: {{ target_date|date:"Yë…„ mì›” 1ì¼" }} ~ ë§ì¼
            </p>
        </div>
        
        <form method="get" class="d-flex gap-2">
            <div class="input-group">
                <span class="input-group-text bg-light fw-bold">ì¡°íšŒ ì›”</span>
                <input type="month" name="month" class="form-control" value="{{ query_month }}">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> ì¡°íšŒ
                </button>
            </div>
        </form>
    </div>

   <div class="row text-center">
        <div class="col-md-3">
            <div class="card bg-primary text-white mb-3 shadow-sm">
                <div class="card-header border-light">ë§¤ì¶œì•¡ (Revenue)</div>
                <div class="card-body"><h4>{{ total_revenue|intcomma }} Ä‘</h4></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white mb-3 shadow-sm">
                <div class="card-header border-light">ë§¤ì¶œì›ê°€ (COGS)</div>
                <div class="card-body">
                    <h4>- {{ total_cogs|intcomma }} Ä‘</h4>
                    <small class="text-light opacity-75" style="font-size: 0.75rem;">
                        (ì´ ë§¤ì…ì•¡: {{ total_purchase_amount|intcomma }} Ä‘)
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark mb-3 shadow-sm">
                <div class="card-header border-dark">íŒê´€ë¹„ (Expenses)</div>
                <div class="card-body"><h4>- {{ total_expense|intcomma }} Ä‘</h4></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {% if operating_profit >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white mb-3 shadow-sm">
                <div class="card-header border-light">ì˜ì—…ì´ìµ (OP)</div>
                <div class="card-body">
                    <h4>{{ operating_profit|intcomma }} Ä‘</h4>
                    <small>ì´ìµë¥ : {{ op_margin }}%</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold bg-light">ğŸ“‹ ì†ìµ ê³„ì‚° ìƒì„¸</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <span>1. ë§¤ì¶œì•¡</span> 
                        <strong class="fs-5">{{ total_revenue|intcomma }} Ä‘</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 text-muted">
                        <span>2. ë§¤ì¶œì›ê°€</span> 
                        <strong>- {{ total_cogs|intcomma }} Ä‘</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 bg-light bg-opacity-50">
                        <span>3. ë§¤ì¶œì´ì´ìµ (Gross Profit)</span> 
                        <strong class="text-primary">{{ gross_profit|intcomma }} Ä‘</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 text-muted">
                        <span>4. íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„</span> 
                        <strong>- {{ total_expense|intcomma }} Ä‘</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 bg-light border-top border-2">
                        <span class="fw-bold">5. ì˜ì—…ì´ìµ (Operating Profit)</span> 
                        <span class="fs-4 fw-bold {% if operating_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ operating_profit|intcomma }} Ä‘
                        </span>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold bg-light d-flex justify-content-between align-items-center">
                    <span>ğŸ“‰ ë¹„ìš©(íŒê´€ë¹„) ìƒì„¸ ë‚´ì—­</span>
                    <span class="badge bg-secondary">Total: {{ total_expense|intcomma }} Ä‘</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ê³„ì •ê³¼ëª©</th>
                                <th class="text-end">ê¸ˆì•¡</th>
                                <th class="text-end" style="width: 30%;">ë¹„ì¤‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in expense_list %}
                            <tr>
                                <td>{{ item.category }}</td>
                                <td class="text-end fw-bold">{{ item.sum|intcomma }} Ä‘</td>
                                <td class="text-end text-muted small">
                                    {% widthratio item.sum total_expense 100 %}%
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-5 text-muted">í•´ë‹¹ ì›”ì— ë“±ë¡ëœ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}